services:
  proxy:
    image: traefik:v3.3
    hostname: nrc-023054.cadc.dao.nrc.ca
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    command:
      - "--log.level=INFO"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.directory=/configuration/"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
    volumes:
      - "server_certs:/server_certs:ro"
      - "proxy_config:/configuration:ro"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    depends_on:
      - "storage"
    networks:
      - "dev"
  reg:
    image: nginx:alpine
    networks:
      - "dev"
    volumes:
      - "reg_config:/usr/share/nginx/html:ro"
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.reg.loadbalancer.server.port=80"
      - "traefik.http.routers.reg.rule=(Host(`nrc-023054.cadc.dao.nrc.ca`) && PathPrefix(`/reg`))"
      - "traefik.http.routers.reg.entrypoints=websecure"
      - "traefik.http.routers.reg.service=reg"
      - "traefik.http.routers.reg.tls=true"
      - "traefik.http.routers.reg.tls.domains[0].main=cadc.dao.nrc.ca"
      - "traefik.http.routers.reg.tls.domains[0].sans=*.cadc.dao.nrc.ca"

  storage:
    image: at88mph/storage-ui:1.3.0-20250429T182033
    ports:
      - "5555:5555"
      - "1099:1099"
    user: "tomcat:tomcat"
    networks:
      - "dev"
    volumes:
      - "storage_config:/config"
      - "ca_certs:/config/cacerts:ro"
    depends_on:
      - "redis"
    environment:
      CATALINA_OPTS: "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=0.0.0.0:5555 -Djmx.rmi.registry.port=1099 -Djmx.rmi.port=1099 -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.port=1099 -Dca.nrc.cadc.auth.IdentityManager=org.opencadc.auth.StandardIdentityManager -Dorg.opencadc.vosui.mode=dev -Dtomcat.connector.scheme=https -Dtomcat.connector.proxyName=nrc-023054.cadc.dao.nrc.ca -Dtomcat.connector.proxyPort=443 -Dca.nrc.cadc.util.Log4jInit.messageOnly=false"
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.storage.loadbalancer.server.port=8080"
      - "traefik.http.routers.storage.rule=(Host(`nrc-023054.cadc.dao.nrc.ca`) && PathPrefix(`/storage`))"
      - "traefik.http.routers.storage.entrypoints=websecure"
      - "traefik.http.routers.storage.service=storage"
      - "traefik.http.routers.storage.tls=true"
      - "traefik.http.routers.storage.tls.domains[0].main=cadc.dao.nrc.ca"
      - "traefik.http.routers.storage.tls.domains[0].sans=*.cadc.dao.nrc.ca"

  redis:
    image: redis:7
    networks:
      - "dev"

networks:
  dev:
    external: true

volumes:
  server_certs:
    external: true
  ca_certs:
    external: true
  storage_config:
    external: true
  reg_config:
    external: true
  proxy_config:
    external: true
